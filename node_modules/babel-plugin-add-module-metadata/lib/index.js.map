{"version":3,"sources":["../src/index.js"],"names":["t","types","visitor","Identifier","exit","path","state","maybeAddEsModuleFlagCase2","StringLiteral","maybeAddEsModuleFlagCase1","babelIpc","pkgs","node","value","parent","isCallExpression","callee","isMemberExpression","isIdentifier","object","name","property","args","arguments","length","isStringLiteral","isObjectExpression","addEsModuleFlag","esModuleFlagAdded","filenameRelative","file","opts","filenameAbsolute","npath","resolve","pkgDir","getPackageDir","pkgJson","join","get","rootPkgJson","pkgId","version","manifest","addModuleFlags","relative","esModule","log","PluginLogger","info"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * Â© 2017 Liferay, Inc. <https://liferay.com>\n *\n * SPDX-License-Identifier: LGPL-3.0-or-later\n */\n\nimport * as babelIpc from 'liferay-npm-build-tools-common/lib/babel-ipc';\nimport * as pkgs from 'liferay-npm-build-tools-common/lib/packages';\nimport PluginLogger from 'liferay-npm-build-tools-common/lib/plugin-logger';\nimport npath from 'path';\nimport readJsonSync from 'read-json-sync';\n\n/**\n * @return {object} a babel visitor\n */\nexport default function({types: t}) {\n\treturn {\n\t\tvisitor: {\n\t\t\tIdentifier: {\n\t\t\t\texit(path, state) {\n\t\t\t\t\tmaybeAddEsModuleFlagCase2(t, path, state);\n\t\t\t\t},\n\t\t\t},\n\t\t\tStringLiteral: {\n\t\t\t\texit(path, state) {\n\t\t\t\t\tmaybeAddEsModuleFlagCase1(t, path, state);\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t};\n}\n\n/**\n * Add `esModule` flag when `__esModule` is being assigned true through\n * `Object.defineProperty()`.\n * @param {object} t\n * @param {object} path\n * @param {object} state\n * @return {boolean} true if `esModule` flag has been added\n */\nfunction maybeAddEsModuleFlagCase1(t, path, state) {\n\tconst {node} = path;\n\n\tif (node.value !== '__esModule') {\n\t\treturn false;\n\t}\n\n\tconst {parent} = path;\n\n\tif (!t.isCallExpression(parent)) {\n\t\treturn false;\n\t}\n\n\tconst {callee} = parent;\n\n\tif (\n\t\t!t.isMemberExpression(callee) ||\n\t\t!t.isIdentifier(callee.object) ||\n\t\tcallee.object.name !== 'Object' ||\n\t\t!t.isIdentifier(callee.property) ||\n\t\tcallee.property.name !== 'defineProperty'\n\t) {\n\t\treturn false;\n\t}\n\n\tconst args = parent.arguments;\n\n\tif (args.length != 3) {\n\t\treturn false;\n\t}\n\n\tif (\n\t\t!t.isIdentifier(args[0]) ||\n\t\targs[0].name !== 'exports' ||\n\t\t!t.isStringLiteral(args[1]) ||\n\t\targs[1].value !== '__esModule' ||\n\t\t!t.isObjectExpression(args[2])\n\t) {\n\t\treturn false;\n\t}\n\n\taddEsModuleFlag(state);\n\n\treturn true;\n}\n\n/**\n * Add `esModule` flag when `__esModule` is being assigned true through\n * `module.exports` or `exports`.\n * @param {object} t\n * @param {object} path\n * @param {object} state\n * @return {boolean} true if `esModule` flag has been added\n */\nfunction maybeAddEsModuleFlagCase2(t, path, state) {\n\tconst {node} = path;\n\n\tif (node.name !== '__esModule') {\n\t\treturn false;\n\t}\n\n\tconst {parent} = path;\n\n\tif (!t.isMemberExpression(parent) || !parent.object === 'exports') {\n\t\treturn false;\n\t}\n\n\taddEsModuleFlag(state);\n\n\treturn true;\n}\n\n/**\n * Add `esModule` flag to current JS module.\n * @param {object} state\n */\nfunction addEsModuleFlag(state) {\n\tif (state.esModuleFlagAdded) {\n\t\treturn;\n\t}\n\n\tconst {filenameRelative} = state.file.opts;\n\tconst filenameAbsolute = npath.resolve(filenameRelative);\n\tconst pkgDir = pkgs.getPackageDir(filenameRelative);\n\tconst pkgJson = readJsonSync(npath.join(pkgDir, 'package.json'));\n\n\tconst {rootPkgJson} = babelIpc.get(state);\n\n\tconst pkgId =\n\t\tpkgJson.name === rootPkgJson.name\n\t\t\t? '/'\n\t\t\t: `${pkgJson.name}@${pkgJson.version}`;\n\n\tconst {manifest} = babelIpc.get(state);\n\n\tmanifest.addModuleFlags(pkgId, npath.relative(pkgDir, filenameAbsolute), {\n\t\tesModule: true,\n\t});\n\n\tstate.esModuleFlagAdded = true;\n\n\tconst {log} = babelIpc.get(state, () => ({\n\t\tlog: new PluginLogger(),\n\t}));\n\n\tlog.info('add-module-metadata', \"Added 'esModule' flag\");\n}\n"]}